# Datadog Terraform module for Azure Container Apps

Use this Terraform module to install Datadog Serverless Monitoring for Azure Container Apps.

[This Terraform module](https://registry.terraform.io/modules/DataDog/container-app-datadog/azurerm/latest) wraps the [azurerm_container_app](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_app) resource and automatically configures your Container App for Datadog Serverless Monitoring by:

* creating the `azurerm_container_app` resource invocation
* adding the designated volumes, volume_mounts to the main container if the user enables logging
* adding the Datadog agent as a sidecar container to collect metrics, traces, and logs
* configuring environment variables for Datadog instrumentation


<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.5.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | >= 4.49.0 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [azurerm_container_app.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_app) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_container_app_environment_id"></a> [container\_app\_environment\_id](#input\_container\_app\_environment\_id) | The ID of the Container App Environment to host this Container App. | `string` | n/a | yes |
| <a name="input_dapr"></a> [dapr](#input\_dapr) | A `dapr` block as detailed below. | <pre>object({<br/>    app_id       = string,<br/>    app_port     = optional(number),<br/>    app_protocol = optional(string)<br/>  })</pre> | `null` | no |
| <a name="input_datadog_api_key"></a> [datadog\_api\_key](#input\_datadog\_api\_key) | Datadog API key | `string` | n/a | yes |
| <a name="input_datadog_enable_logging"></a> [datadog\_enable\_logging](#input\_datadog\_enable\_logging) | Enables log collection. Defaults to true. | `bool` | `true` | no |
| <a name="input_datadog_env"></a> [datadog\_env](#input\_datadog\_env) | Datadog Environment tag, used for Unified Service Tagging. | `string` | `null` | no |
| <a name="input_datadog_log_level"></a> [datadog\_log\_level](#input\_datadog\_log\_level) | Datadog agent's level of log output in Cloud Run UI, from most to least output: TRACE, DEBUG, INFO, WARN, ERROR, CRITICAL | `string` | `null` | no |
| <a name="input_datadog_logging_path"></a> [datadog\_logging\_path](#input\_datadog\_logging\_path) | Datadog logging path to be used for log collection. Ensure var.datadog\_enable\_logging is true. Must begin with path given in var.datadog\_shared\_volume.path. | `string` | `"/shared-volume/logs/*.log"` | no |
| <a name="input_datadog_service"></a> [datadog\_service](#input\_datadog\_service) | Datadog Service tag, used for Unified Service Tagging. | `string` | `null` | no |
| <a name="input_datadog_shared_volume"></a> [datadog\_shared\_volume](#input\_datadog\_shared\_volume) | Datadog shared volume for log collection. Ensure var.datadog\_enable\_logging is true. Note: will always be of type EmptyDir. If a volume with this name is provided as part of var.template.volume, it will be overridden. | <pre>object({<br/>    name = string<br/>    path = string<br/>  })</pre> | <pre>{<br/>  "name": "shared-volume",<br/>  "path": "/shared-volume"<br/>}</pre> | no |
| <a name="input_datadog_sidecar"></a> [datadog\_sidecar](#input\_datadog\_sidecar) | Datadog sidecar configuration. Nested attributes include:<br/>- image - Image for version of Datadog agent to use.<br/>- name - Name of the sidecar container.<br/>- cpu - CPU units to allocate to the sidecar container.<br/>- memory - Memory to allocate to the sidecar container.<br/>- health\_port - Health port to start the startup probe.<br/>- env - List of environment variables with name and value fieldsfor customizing Datadog agent configuration, if any. | <pre>object({<br/>    image       = optional(string, "index.docker.io/datadog/serverless-init:latest")<br/>    name        = optional(string, "datadog-sidecar")<br/>    cpu         = optional(number, 0.25)<br/>    memory      = optional(string, "0.5Gi")<br/>    health_port = optional(number, 5555)<br/>    env = optional(list(object({ # user-customizable env vars for Datadog agent configuration<br/>      name  = string<br/>      value = string<br/>    })), null)<br/>  })</pre> | <pre>{<br/>  "cpu": 0.25,<br/>  "health_port": 5555,<br/>  "image": "index.docker.io/datadog/serverless-init:latest",<br/>  "memory": "0.5Gi",<br/>  "name": "datadog-sidecar"<br/>}</pre> | no |
| <a name="input_datadog_site"></a> [datadog\_site](#input\_datadog\_site) | Datadog site | `string` | `"datadoghq.com"` | no |
| <a name="input_datadog_tags"></a> [datadog\_tags](#input\_datadog\_tags) | Datadog tags | `list(string)` | `null` | no |
| <a name="input_datadog_version"></a> [datadog\_version](#input\_datadog\_version) | Datadog Version tag, used for Unified Service Tagging. | `string` | `null` | no |
| <a name="input_identity"></a> [identity](#input\_identity) | An `identity` block as detailed below. | <pre>object({<br/>    identity_ids = optional(set(string)),<br/>    principal_id = string,<br/>    tenant_id    = string,<br/>    type         = string<br/>  })</pre> | `null` | no |
| <a name="input_ingress"></a> [ingress](#input\_ingress) | An `ingress` block as detailed below. | <pre>object({<br/>    allow_insecure_connections = optional(bool),<br/>    client_certificate_mode    = optional(string),<br/>    custom_domain = list(object({<br/>      certificate_binding_type = string,<br/>      certificate_id           = string,<br/>      name                     = string<br/>    })),<br/>    exposed_port     = optional(number),<br/>    external_enabled = optional(bool),<br/>    fqdn             = string,<br/>    target_port      = number,<br/>    transport        = optional(string),<br/>    cors = optional(object({<br/>      allow_credentials_enabled = optional(bool),<br/>      allowed_headers           = optional(list(string)),<br/>      allowed_methods           = optional(list(string)),<br/>      allowed_origins           = list(string),<br/>      exposed_headers           = optional(list(string)),<br/>      max_age_in_seconds        = optional(number)<br/>    })),<br/>    ip_security_restriction = optional(list(object({<br/>      action           = string,<br/>      description      = optional(string),<br/>      ip_address_range = string,<br/>      name             = string<br/>    }))),<br/>    traffic_weight = list(object({<br/>      label           = optional(string),<br/>      latest_revision = optional(bool),<br/>      percentage      = number,<br/>      revision_suffix = optional(string)<br/>    }))<br/>  })</pre> | `null` | no |
| <a name="input_max_inactive_revisions"></a> [max\_inactive\_revisions](#input\_max\_inactive\_revisions) | The maximum of inactive revisions allowed for this Container App. | `number` | `null` | no |
| <a name="input_name"></a> [name](#input\_name) | The name for this Container App. | `string` | n/a | yes |
| <a name="input_registry"></a> [registry](#input\_registry) | A `registry` block as detailed below. | <pre>list(object({<br/>    identity             = optional(string),<br/>    password_secret_name = optional(string),<br/>    server               = string,<br/>    username             = optional(string)<br/>  }))</pre> | `null` | no |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name) | The name of the resource group in which the Container App Environment is to be created. Changing this forces a new resource to be created. | `string` | n/a | yes |
| <a name="input_revision_mode"></a> [revision\_mode](#input\_revision\_mode) | The revisions operational mode for the Container App. Possible values include `Single` and `Multiple`. In `Single` mode, a single revision is in operation at any given time. In `Multiple` mode, more than one revision can be active at a time and can be configured with load distribution via the `traffic_weight` block in the `ingress` configuration. | `string` | n/a | yes |
| <a name="input_secret"></a> [secret](#input\_secret) | One or more `secret` block as detailed below. | <pre>set(object({<br/>    identity            = optional(string),<br/>    key_vault_secret_id = optional(string),<br/>    name                = string,<br/>    value               = optional(string)<br/>  }))</pre> | `null` | no |
| <a name="input_tags"></a> [tags](#input\_tags) | A mapping of tags to assign to the Container App. | `map(string)` | `null` | no |
| <a name="input_template"></a> [template](#input\_template) | A `template` block as detailed below. | <pre>object({<br/>    max_replicas                     = optional(number),<br/>    min_replicas                     = optional(number),<br/>    revision_suffix                  = optional(string),<br/>    termination_grace_period_seconds = optional(number),<br/>    azure_queue_scale_rule = optional(list(object({<br/>      name         = string,<br/>      queue_length = number,<br/>      queue_name   = string,<br/>      authentication = list(object({<br/>        secret_name       = string,<br/>        trigger_parameter = string<br/>      }))<br/>    }))),<br/>    container = list(object({<br/>      args    = optional(list(string)),<br/>      command = optional(list(string)),<br/>      cpu     = number,<br/>      image   = string,<br/>      memory  = string,<br/>      name    = string,<br/>      env = optional(list(object({<br/>        name        = string,<br/>        secret_name = optional(string),<br/>        value       = optional(string)<br/>      }))),<br/>      liveness_probe = optional(list(object({<br/>        failure_count_threshold = optional(number),<br/>        host                    = optional(string),<br/>        initial_delay           = optional(number),<br/>        interval_seconds        = optional(number),<br/>        path                    = optional(string),<br/>        port                    = number,<br/>        timeout                 = optional(number),<br/>        transport               = string,<br/>        header = optional(list(object({<br/>          name  = string,<br/>          value = string<br/>        })))<br/>      }))),<br/>      readiness_probe = optional(list(object({<br/>        failure_count_threshold = optional(number),<br/>        host                    = optional(string),<br/>        initial_delay           = optional(number),<br/>        interval_seconds        = optional(number),<br/>        path                    = optional(string),<br/>        port                    = number,<br/>        success_count_threshold = optional(number),<br/>        timeout                 = optional(number),<br/>        transport               = string,<br/>        header = optional(list(object({<br/>          name  = string,<br/>          value = string<br/>        })))<br/>      }))),<br/>      startup_probe = optional(list(object({<br/>        failure_count_threshold = optional(number),<br/>        host                    = optional(string),<br/>        initial_delay           = optional(number),<br/>        interval_seconds        = optional(number),<br/>        path                    = optional(string),<br/>        port                    = number,<br/>        timeout                 = optional(number),<br/>        transport               = string,<br/>        header = optional(list(object({<br/>          name  = string,<br/>          value = string<br/>        })))<br/>      }))),<br/>      volume_mounts = optional(list(object({<br/>        name     = string,<br/>        path     = string,<br/>        sub_path = optional(string)<br/>      })))<br/>    })),<br/>    custom_scale_rule = optional(list(object({<br/>      custom_rule_type = string,<br/>      metadata         = map(string),<br/>      name             = string,<br/>      authentication = optional(list(object({<br/>        secret_name       = string,<br/>        trigger_parameter = string<br/>      })))<br/>    }))),<br/>    http_scale_rule = optional(list(object({<br/>      concurrent_requests = string,<br/>      name                = string,<br/>      authentication = optional(list(object({<br/>        secret_name       = string,<br/>        trigger_parameter = optional(string)<br/>      })))<br/>    }))),<br/>    init_container = optional(list(object({<br/>      args    = optional(list(string)),<br/>      command = optional(list(string)),<br/>      cpu     = optional(number),<br/>      image   = string,<br/>      memory  = optional(string),<br/>      name    = string,<br/>      env = optional(list(object({<br/>        name        = string,<br/>        secret_name = optional(string),<br/>        value       = optional(string)<br/>      }))),<br/>      volume_mounts = optional(list(object({<br/>        name     = string,<br/>        path     = string,<br/>        sub_path = optional(string)<br/>      })))<br/>    }))),<br/>    tcp_scale_rule = optional(list(object({<br/>      concurrent_requests = string,<br/>      name                = string,<br/>      authentication = optional(list(object({<br/>        secret_name       = string,<br/>        trigger_parameter = optional(string)<br/>      })))<br/>    }))),<br/>    volume = optional(list(object({<br/>      mount_options = optional(string),<br/>      name          = string,<br/>      storage_name  = optional(string),<br/>      storage_type  = optional(string)<br/>    })))<br/>  })</pre> | n/a | yes |
| <a name="input_timeouts"></a> [timeouts](#input\_timeouts) | n/a | <pre>object({<br/>    create = optional(string),<br/>    delete = optional(string),<br/>    read   = optional(string),<br/>    update = optional(string)<br/>  })</pre> | `null` | no |
| <a name="input_workload_profile_name"></a> [workload\_profile\_name](#input\_workload\_profile\_name) | The name of the Workload Profile in the Container App Environment to place this Container App. | `string` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_container_app_environment_id"></a> [container\_app\_environment\_id](#output\_container\_app\_environment\_id) | The ID of the Container App Environment to host this Container App. |
| <a name="output_custom_domain_verification_id"></a> [custom\_domain\_verification\_id](#output\_custom\_domain\_verification\_id) | The ID of the Custom Domain Verification for this Container App. |
| <a name="output_dapr"></a> [dapr](#output\_dapr) | A `dapr` block as detailed below. |
| <a name="output_id"></a> [id](#output\_id) | The ID of the Container App. |
| <a name="output_identity"></a> [identity](#output\_identity) | An `identity` block as detailed below. |
| <a name="output_ignored_containers"></a> [ignored\_containers](#output\_ignored\_containers) | List of containers that are ignored by the module. |
| <a name="output_ignored_volume_mounts"></a> [ignored\_volume\_mounts](#output\_ignored\_volume\_mounts) | List of volume mounts that overlap with the Datadog shared volume and are ignored by the module. |
| <a name="output_ignored_volumes"></a> [ignored\_volumes](#output\_ignored\_volumes) | List of volumes that are ignored by the module. |
| <a name="output_ingress"></a> [ingress](#output\_ingress) | An `ingress` block as detailed below. |
| <a name="output_latest_revision_fqdn"></a> [latest\_revision\_fqdn](#output\_latest\_revision\_fqdn) | The FQDN of the Latest Revision of the Container App. |
| <a name="output_latest_revision_name"></a> [latest\_revision\_name](#output\_latest\_revision\_name) | The name of the latest Container Revision. |
| <a name="output_location"></a> [location](#output\_location) | The location this Container App is deployed in. This is the same as the Environment in which it is deployed. |
| <a name="output_max_inactive_revisions"></a> [max\_inactive\_revisions](#output\_max\_inactive\_revisions) | The maximum of inactive revisions allowed for this Container App. |
| <a name="output_name"></a> [name](#output\_name) | The name for this Container App. |
| <a name="output_outbound_ip_addresses"></a> [outbound\_ip\_addresses](#output\_outbound\_ip\_addresses) | A list of the Public IP Addresses which the Container App uses for outbound network access. |
| <a name="output_registry"></a> [registry](#output\_registry) | A `registry` block as detailed below. |
| <a name="output_resource_group_name"></a> [resource\_group\_name](#output\_resource\_group\_name) | The name of the resource group in which the Container App Environment is to be created. Changing this forces a new resource to be created. |
| <a name="output_revision_mode"></a> [revision\_mode](#output\_revision\_mode) | The revisions operational mode for the Container App. Possible values include `Single` and `Multiple`. In `Single` mode, a single revision is in operation at any given time. In `Multiple` mode, more than one revision can be active at a time and can be configured with load distribution via the `traffic_weight` block in the `ingress` configuration. |
| <a name="output_secret"></a> [secret](#output\_secret) | One or more `secret` block as detailed below. |
| <a name="output_tags"></a> [tags](#output\_tags) | A mapping of tags to assign to the Container App. |
| <a name="output_template"></a> [template](#output\_template) | A `template` block as detailed below. |
| <a name="output_timeouts"></a> [timeouts](#output\_timeouts) | n/a |
| <a name="output_workload_profile_name"></a> [workload\_profile\_name](#output\_workload\_profile\_name) | The name of the Workload Profile in the Container App Environment to place this Container App. |
<!-- END_TF_DOCS -->
